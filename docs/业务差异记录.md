# /webhook/signal 业务差异记录

## 背景
相较于原 Node.js 版本仓库 `../deribit_webhook`，当前 Python 版本在 `/webhook/signal` 流程中已补齐账户校验、信号解析到下单执行的大部分逻辑。下表记录曾经识别的差异点及目前处理状态，便于持续回归和验证。

## 差异清单
1. **企业微信多阶段提醒**（✅ 已补齐）  
   - 原实现：在执行减仓、止盈、止损等操作时，会调用 `sendPositionAdjustmentNotification`、`sendProfitCloseNotification`、`sendStopLossNotification`，先推送“开始”通知，再在操作结束后推送结果，包含 TV ID、合约、方向与执行信息。（`../deribit_webhook/src/services/option-trading.ts:270`, `332`, `389`, `598-778`）  
   - 现状：Python 版本已实现 `_send_position_adjustment_notification`、`_send_profit_close_notification`、`_send_stop_loss_notification`，并在相关业务分支调用；通知内容通过 `wechat_notification_service` 转Markdown推送，补齐提醒链路。

2. **渐进限价执行策略**（✅ 已补齐）  
   - 原实现：盘口价差合理时进入 `executeProgressiveLimitStrategy`，按步递进调价、超时回落、记录 Delta 并发送通知。（`../deribit_webhook/src/services/place-option-order.ts:292-340`）  
   - 现状：Python 版本新增 `src/services/progressive_limit_strategy.py` 并在 `_place_real_option_order` 中接入；策略支持逐步 `edit` 订单、回溯Market收尾，并返回结构化结果供通知与回写使用。

3. **下单结果通知**（✅ 已补齐）  
   - 原实现：所有委托都会通过 `sendOrderNotificationPure` 推送企业微信，附价差、Tick 等指标，失败同样告警。（`../deribit_webhook/src/services/place-option-order.ts:263-397`, `512`）  
   - 现状：Python 版本引入 `OrderNotificationPayload` 与 `send_order_notification`，在真实下单流程（含渐进策略和异常分支）统一发送企业微信通知，对接价差、Tick、尝试次数等信息。

## 建议
- 回归测试：在 Mock/Test 环境复现减仓、止盈、止损、渐进限价场景，确认企业微信收到对应通知并核对字段。
- 监控校验：在真实环境上线后对接一周指标，确认通知延迟与失败率。
