# /webhook/signal 业务差异记录

## 背景
相较于原 Node.js 版本仓库 `../deribit_webhook`，当前 Python 版本在 `/webhook/signal` 流程中仅保留了基础的账户校验、信号解析与下单调用，部分关键业务逻辑尚未同步。以下列出目前确认的差异，便于补齐。

## 差异清单
1. **企业微信多阶段提醒缺失**  
   - 原实现：在执行减仓、止盈、止损等操作时，都会调用 `sendPositionAdjustmentNotification`、`sendProfitCloseNotification`、`sendStopLossNotification`，先推送“开始”通知，再在操作结束后推送结果，包含 TV ID、合约、方向与执行信息。（参见 `../deribit_webhook/src/services/option-trading.ts:270`, `332`, `389`, `598-778`）  
   - 现状：Python 版本虽然在相应分支调用 `self._send_*_notification`（`src/services/option_trading_service.py:760-909`），但这些方法未实现，导致企业微信告警链路整体缺失。

2. **渐进限价执行策略被弱化**  
   - 原实现：当盘口价差合理时，会进入 `executeProgressiveLimitStrategy`，按照预设步长逐步调整委托价格并等待成交，结束后还会记录 Delta 并发送通知。（`../deribit_webhook/src/services/place-option-order.ts:292-340`）  
   - 现状：Python 版本 `_place_progressive_order` 仅一次性计算折中价并直接下单（`src/services/option_trading_service.py:700-738`），没有分步追价与等待逻辑，难以复现原有的成交策略。

3. **下单结果通知缺失**  
   - 原实现：所有委托都会通过 `sendOrderNotificationPure` 推送企业微信，包括手动下单、渐进策略和异常回退流程，并附带价差、Tick 等指标，失败时同样有告警。（`../deribit_webhook/src/services/place-option-order.ts:263-397`, `512`）  
   - 现状：Python 版本未在下单链路中发送任何企业微信通知，导致业务侧无法实时获知成交、失败等关键信息。

## 建议
- 依据上述差异，补齐企业微信通知服务在 Python 版本中的实现与调用。
- 引入与原实现等价的渐进限价策略组件（或保留现有接口但补充逻辑）。
- 为真实下单和策略执行补上通知、Delta 记录等配套流程，以维护监控和追溯能力。
