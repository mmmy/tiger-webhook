# 渐进限价策略技术需求文档

## 1. 功能概述

渐进限价策略是一种高级订单执行策略，通过逐步调整订单价格来提高成交概率和获得更好的成交价格。

## 2. 核心特性

### 2.1 渐进价格调整
- 支持多个价格调整步骤
- 每步调整幅度可配置
- 支持买入和卖出方向的价格调整

### 2.2 超时机制
- 每个价格级别有独立的超时设置
- 超时后自动进入下一个价格级别
- 支持总体订单超时控制

### 2.3 订单状态管理
- 实时监控订单状态
- 支持部分成交处理
- 支持订单取消和修改

## 3. 技术架构

### 3.1 类结构设计

```python
class ProgressiveLimitStrategy:
    """渐进限价策略主类"""

    def __init__(self, deribit_client, config):
        self.client = deribit_client
        self.config = config
        self.active_orders = {}

    async def execute_progressive_order(self, order_params):
        """执行渐进限价订单"""
        pass

    async def monitor_order_progression(self, order_id):
        """监控订单进展"""
        pass

    def calculate_price_levels(self, initial_price, direction):
        """计算价格级别"""
        pass
```

### 3.2 配置参数

```python
PROGRESSIVE_LIMIT_CONFIG = {
    "enabled": True,
    "price_levels": [
        {"step": 0, "adjustment": 0.0, "timeout": 30000},  # 初始价格
        {"step": 1, "adjustment": 0.1, "timeout": 30000},  # 第一次调整
        {"step": 2, "adjustment": 0.2, "timeout": 30000},  # 第二次调整
        {"step": 3, "adjustment": 0.3, "timeout": 30000},  # 第三次调整
    ],
    "max_total_timeout": 120000,  # 最大总超时时间
    "min_volume_threshold": 0.1,  # 最小成交量阈值
}
```

## 4. API接口设计

### 4.1 策略执行接口

```python
async def execute_progressive_limit_order(
    instrument_name: str,
    amount: float,
    direction: str,  # "buy" or "sell"
    initial_price: float,
    price_adjustment_type: str = "percentage",  # "percentage" or "absolute"
    max_steps: int = 3,
    step_timeout: int = 30000
) -> Dict:
    """
    执行渐进限价订单

    Args:
        instrument_name: 交易标的名称
        amount: 订单数量
        direction: 交易方向
        initial_price: 初始价格
        price_adjustment_type: 价格调整类型
        max_steps: 最大调整步数
        step_timeout: 每步超时时间(毫秒)

    Returns:
        Dict: 订单执行结果
    """
```

### 4.2 订单监控接口

```python
async def monitor_progressive_order(
    order_id: str,
    callback: Callable = None
) -> AsyncGenerator[Dict, None]:
    """
    监控渐进订单执行状态

    Args:
        order_id: 订单ID
        callback: 状态回调函数

    Yields:
        Dict: 订单状态更新
    """
```

## 5. 业务逻辑流程

### 5.1 订单执行流程

1. **初始化阶段**
   - 验证订单参数
   - 计算价格级别序列
   - 创建初始订单

2. **监控阶段**
   - 启动订单状态监控
   - 检查订单成交状态
   - 监控超时情况

3. **调整阶段**
   - 超时后取消当前订单
   - 计算新价格
   - 创建新订单

4. **完成阶段**
   - 订单完全成交或达到最大重试次数
   - 清理监控资源
   - 返回执行结果

### 5.2 价格调整算法

```python
def calculate_adjusted_price(self, current_price, step, direction):
    """
    计算调整后的价格

    Args:
        current_price: 当前价格
        step: 调整步数
        direction: 交易方向

    Returns:
        float: 调整后的价格
    """
    adjustment = self.config["price_levels"][step]["adjustment"]

    if direction == "buy":
        # 买入时提高价格以增加成交概率
        return current_price * (1 + adjustment)
    else:
        # 卖出时降低价格以增加成交概率
        return current_price * (1 - adjustment)
```

## 6. 错误处理

### 6.1 异常类型

```python
class ProgressiveLimitError(Exception):
    """渐进限价策略基础异常"""
    pass

class OrderTimeoutError(ProgressiveLimitError):
    """订单超时异常"""
    pass

class MaxRetriesExceededError(ProgressiveLimitError):
    """超过最大重试次数异常"""
    pass

class InvalidOrderParametersError(ProgressiveLimitError):
    """无效订单参数异常"""
    pass
```

### 6.2 错误恢复策略

- 网络错误：自动重试
- 订单取消失败：记录警告并继续
- 价格计算错误：终止策略并返回错误
- 账户余额不足：终止策略并返回错误

## 7. 监控和日志

### 7.1 关键指标

- 订单执行时间
- 价格调整次数
- 成交价格与初始价格差异
- 成交率

### 7.2 日志记录

```python
import logging

logger = logging.getLogger(__name__)

def log_order_progression(order_id, step, status, price=None):
    """记录订单进展日志"""
    logger.info(f"Progressive Order {order_id} - Step {step}: {status}")
    if price:
        logger.info(f"Price adjusted to: {price}")
```

## 8. 测试策略

### 8.1 单元测试

- 价格调整算法测试
- 超时处理测试
- 订单状态监控测试

### 8.2 集成测试

- 与Deribit API集成测试
- 真实市场环境测试
- 错误恢复测试

### 8.3 性能测试

- 大量订单并发执行测试
- 高频率价格调整测试
- 内存和CPU使用率测试

## 9. 配置管理

### 9.1 环境配置

```python
# 生产环境配置
PRODUCTION_CONFIG = {
    "enabled": True,
    "price_levels": [
        {"step": 0, "adjustment": 0.0, "timeout": 60000},
        {"step": 1, "adjustment": 0.05, "timeout": 60000},
        {"step": 2, "adjustment": 0.1, "timeout": 60000},
    ],
    "max_total_timeout": 180000,
}

# 测试环境配置
TEST_CONFIG = {
    "enabled": True,
    "price_levels": [
        {"step": 0, "adjustment": 0.0, "timeout": 5000},
        {"step": 1, "adjustment": 0.1, "timeout": 5000},
    ],
    "max_total_timeout": 15000,
}
```

### 9.2 动态配置

- 支持运行时配置更新
- 支持A/B测试配置
- 支持按标的配置不同参数

## 10. 依赖关系

- Deribit Python客户端
- 异步HTTP客户端
- 配置管理模块
- 日志系统
- 监控系统

## 11. 实施优先级

1. **Phase 1**: 基础渐进限价策略实现
2. **Phase 2**: 高级监控和错误处理
3. **Phase 3**: 性能优化和监控集成
4. **Phase 4**: 动态配置和A/B测试

## 12. 风险评估

### 12.1 技术风险

- 订单执行延迟
- 价格滑点
- 网络连接问题

### 12.2 业务风险

- 价格调整过于激进导致亏损
- 订单成交不足
- 系统资源消耗过大

### 12.3 风险缓解措施

- 设置最大调整幅度限制
- 实施严格的超时控制
- 增加系统监控和告警